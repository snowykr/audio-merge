<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Merge - 오디오 파일 병합 도구</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app" x-data="audioMergeApp()">
        <!-- Header -->
        <header class="bg-white shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-6">
                    <div class="flex items-center">
                        <i class="fas fa-music text-blue-600 text-2xl mr-3"></i>
                        <h1 class="text-2xl font-bold text-gray-900">Audio Merge</h1>
                    </div>
                    <div class="text-sm text-gray-500">
                        오디오 파일 병합 도구
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Upload Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">
                    <i class="fas fa-upload mr-2"></i>파일 업로드
                </h2>
                
                <!-- File Drop Zone -->
                <div 
                    id="drop-zone" 
                    class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-blue-400 transition-colors"
                    x-bind:class="isDragging ? 'border-blue-400 bg-blue-50' : ''"
                    @dragover.prevent="isDragging = true"
                    @dragleave.prevent="isDragging = false"
                    @drop.prevent="handleFileDrop($event)"
                >
                    <div class="text-center">
                        <i class="fas fa-cloud-upload-alt text-4xl text-gray-400 mb-4"></i>
                        <div class="mb-4">
                            <label for="file-upload" class="cursor-pointer">
                                <span class="text-lg font-medium text-gray-900">
                                    파일을 드래그하거나 클릭하여 업로드
                                </span>
                                <input 
                                    id="file-upload" 
                                    name="file-upload" 
                                    type="file" 
                                    class="sr-only" 
                                    multiple 
                                    accept=".wav,.mp3"
                                    @change="handleFileSelect($event)"
                                >
                            </label>
                        </div>
                        <p class="text-sm text-gray-500">
                            WAV, MP3 파일만 지원 (최대 500MB/파일, 2GB 총합, 20개 파일)
                        </p>
                    </div>
                </div>

                <!-- File List -->
                <div x-show="files.length > 0" class="mt-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-3">업로드된 파일</h3>
                    <div class="space-y-2">
                        <template x-for="(file, index) in files" :key="index">
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                                <div class="flex items-center">
                                    <i class="fas fa-file-audio text-blue-500 mr-3"></i>
                                    <div>
                                        <div class="font-medium" x-text="file.name"></div>
                                        <div class="text-sm text-gray-500" x-text="formatFileSize(file.size)"></div>
                                    </div>
                                </div>
                                <button 
                                    @click="removeFile(index)"
                                    class="text-red-500 hover:text-red-700"
                                >
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Options Section -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8" x-show="files.length > 0">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">
                    <i class="fas fa-cog mr-2"></i>병합 옵션
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Cross-fade 길이 (ms)
                        </label>
                        <input 
                            type="range" 
                            min="0" 
                            max="5000" 
                            x-model="options.fade_duration_ms"
                            class="w-full"
                        >
                        <div class="text-sm text-gray-500 mt-1" x-text="options.fade_duration_ms + 'ms'"></div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            버퍼 크기
                        </label>
                        <select x-model="options.buffer_size" class="w-full p-2 border border-gray-300 rounded-md">
                            <option value="32768">32KB (빠름)</option>
                            <option value="65536">64KB (권장)</option>
                            <option value="131072">128KB (안정)</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-4">
                    <label class="flex items-center">
                        <input 
                            type="checkbox" 
                            x-model="options.auto_convert"
                            class="rounded border-gray-300 text-blue-600 shadow-sm focus:border-blue-300 focus:ring focus:ring-blue-200 focus:ring-opacity-50"
                        >
                        <span class="ml-2 text-sm text-gray-700">포맷 불일치 시 자동 변환</span>
                    </label>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="bg-white rounded-lg shadow-md p-6 mb-8" x-show="files.length > 1">
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-600">
                        <span x-text="files.length"></span>개 파일이 선택되었습니다
                    </div>
                    <button 
                        @click="startMerge()"
                        :disabled="isProcessing"
                        class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <i class="fas fa-play mr-2"></i>
                        <span x-text="isProcessing ? '처리 중...' : '병합 시작'"></span>
                    </button>
                </div>
            </div>

            <!-- Progress Section -->
            <div class="bg-white rounded-lg shadow-md p-6" x-show="currentTask">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">
                    <i class="fas fa-tasks mr-2"></i>진행 상황
                </h2>
                
                <div class="mb-4">
                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                        <span x-text="taskStatus.current_step || '대기 중'"></span>
                        <span x-text="(taskStatus.progress || 0) + '%'"></span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div 
                            class="bg-blue-600 h-2 rounded-full transition-all duration-300"
                            :style="'width: ' + (taskStatus.progress || 0) + '%'"
                        ></div>
                    </div>
                </div>
                
                <div class="text-sm text-gray-600 mb-4" x-text="taskStatus.message || '작업을 준비하고 있습니다...'"></div>
                
                <!-- Download Button -->
                <div x-show="taskStatus.status === 'completed'" class="mt-4">
                    <button 
                        @click="downloadResult()"
                        class="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700"
                    >
                        <i class="fas fa-download mr-2"></i>결과 파일 다운로드
                    </button>
                </div>
                
                <!-- Error Message -->
                <div x-show="taskStatus.status === 'failed'" class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
                    <div class="text-red-800">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        오류가 발생했습니다: <span x-text="taskStatus.message"></span>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="bg-white border-t border-gray-200 mt-16">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="text-center text-gray-500 text-sm">
                    <p>© 2025 Audio Merge Tool. Python으로 제작된 오디오 파일 병합 도구입니다.</p>
                </div>
            </div>
        </footer>
    </div>

    <script>
        function audioMergeApp() {
            return {
                files: [],
                isDragging: false,
                isProcessing: false,
                currentTask: null,
                taskStatus: {},
                eventSource: null,
                options: {
                    fade_duration_ms: 0,
                    buffer_size: 131072,
                    auto_convert: true,
                    output_format: 'wav'
                },
                
                handleFileDrop(event) {
                    this.isDragging = false;
                    const files = Array.from(event.dataTransfer.files);
                    this.addFiles(files);
                },
                
                handleFileSelect(event) {
                    const files = Array.from(event.target.files);
                    this.addFiles(files);
                },
                
                addFiles(newFiles) {
                    newFiles.forEach(file => {
                        if (this.validateFile(file)) {
                            this.files.push(file);
                        }
                    });
                },
                
                validateFile(file) {
                    const allowedTypes = ['audio/wav', 'audio/mpeg', 'audio/mp3'];
                    const maxSize = 500 * 1024 * 1024; // 500MB
                    
                    if (!allowedTypes.includes(file.type) && !file.name.match(/\.(wav|mp3)$/i)) {
                        alert('지원되지 않는 파일 형식입니다: ' + file.name);
                        return false;
                    }
                    
                    if (file.size > maxSize) {
                        alert('파일 크기가 너무 큽니다: ' + file.name);
                        return false;
                    }
                    
                    return true;
                },
                
                removeFile(index) {
                    this.files.splice(index, 1);
                },
                
                formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },
                
                async startMerge() {
                    if (this.files.length < 2) {
                        alert('최소 2개의 파일이 필요합니다.');
                        return;
                    }
                    
                    this.isProcessing = true;
                    
                    try {
                        // 1. 파일 업로드
                        const uploadData = await this.uploadFiles();
                        
                        // 2. 병합 시작
                        const mergeResponse = await this.startMergeTask(uploadData.upload_id);
                        
                        // 3. 진행률 추적 시작
                        this.currentTask = mergeResponse.task_id;
                        this.startProgressTracking(mergeResponse.task_id);
                        
                    } catch (error) {
                        alert('오류가 발생했습니다: ' + error.message);
                        this.isProcessing = false;
                    }
                },
                
                async uploadFiles() {
                    const formData = new FormData();
                    this.files.forEach(file => {
                        formData.append('files', file);
                    });
                    formData.append('options', JSON.stringify(this.options));
                    
                    const response = await fetch('/api/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error('파일 업로드 실패');
                    }
                    
                    return await response.json();
                },
                
                async startMergeTask(uploadId) {
                    const response = await fetch('/api/merge', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            upload_id: uploadId,
                            options: this.options
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error('병합 작업 시작 실패');
                    }
                    
                    return await response.json();
                },
                
                startProgressTracking(taskId) {
                    this.eventSource = new EventSource(`/api/events/${taskId}`);
                    
                    this.eventSource.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.taskStatus = data;
                        
                        if (data.status === 'completed' || data.status === 'failed') {
                            this.isProcessing = false;
                            this.eventSource.close();
                        }
                    };
                    
                    this.eventSource.onerror = () => {
                        this.isProcessing = false;
                        this.eventSource.close();
                    };
                },
                
                async downloadResult() {
                    if (!this.currentTask) return;
                    
                    const link = document.createElement('a');
                    link.href = `/api/download/${this.currentTask}`;
                    link.download = `merged_audio_${this.currentTask.substring(0, 8)}.wav`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
            }
        }
    </script>
</body>
</html> 